
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../17_analyze_report_ai/">
      
      
        <link rel="next" href="../19_templates/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Payments - VulnScanAI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#file-paymentspy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="VulnScanAI Documentation" class="md-header__button md-logo" aria-label="VulnScanAI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            VulnScanAI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Payments
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="VulnScanAI Documentation" class="md-nav__button md-logo" aria-label="VulnScanAI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    VulnScanAI Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../toc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Table of Contents
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    VulnScanAI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            VulnScanAI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    App Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            App Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01_app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_2" >
        
          
          <label class="md-nav__link" for="__nav_3_1_2" id="__nav_3_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Scanners Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_2">
            <span class="md-nav__icon md-icon"></span>
            Scanners Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02_scanners/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03_nmap_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nmap Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04_nikto_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nikto Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05_zap_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ZAP Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06_mobsf_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MobSF Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07_sqlmap_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SQLMap Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08_ssl_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SSL Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09_prowler_scanner_aws/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prowler AWS Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10_prowler_scanner_gcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prowler GCP Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11_cloudsploit_scanner_azure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CloudSploit Azure Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Views Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1_3">
            <span class="md-nav__icon md-icon"></span>
            Views Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12_views/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13_views_init/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    init
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14_main/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Main
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15_auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16_genai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GenAI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../17_analyze_report_ai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AI Report Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Payments
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          <label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Templates Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            Templates Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../19_templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../20_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../21_home/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../22_about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../23_contact_us/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contact Us
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../24_request_demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Request Demo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../25_login/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Login
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../26_profile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Profile
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    extensions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../forms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    forms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    models
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="file-paymentspy">File: <code>payments.py</code></h1>
<p><strong>Purpose:</strong> This file defines the <code>payments_bp</code> Blueprint, responsible for managing payment-related functionalities within the application. It facilitates integration with the PayPal API for handling subscription payments, updating user subscription details, and recording payment transactions.</p>
<p><strong>Overview:</strong></p>
<p>The <code>payments.py</code> file encompasses the following key functionalities:</p>
<ul>
<li><strong>PayPal API Integration:</strong> It orchestrates interactions with the PayPal API to initiate and finalize orders, in addition to retrieving comprehensive order details. Robust error handling and retry mechanisms are in place.</li>
<li><strong>Subscription Management:</strong> It diligently updates user subscription data, including the subscription ID and expiry date, within the database upon successful payment confirmation.</li>
<li><strong>Payment Recording:</strong> The module meticulously records crucial payment information, such as user details, amounts, currency, transaction identifiers, and status, within the database.</li>
<li><strong>Error Handling:</strong> Comprehensive error handling strategies, incorporating custom exceptions and logging, are implemented to ensure the dependability of the payment processing workflow.</li>
<li><strong>Idempotency:</strong> UUIDs are employed to generate unique idempotency keys for PayPal capture requests, mitigating the risk of duplicate transactions.</li>
<li><strong>Payer Action Handling:</strong> The code anticipates and manages scenarios where PayPal mandates user intervention (e.g., supplementary verification steps) by seamlessly redirecting users to the PayPal platform.</li>
</ul>
<p><strong>Key Components and Functionality:</strong></p>
<ul>
<li>
<p><strong><code>payments_bp</code> Blueprint:</strong></p>
<ul>
<li>Serves as the foundation for defining all payment-centric routes within the application.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Blueprint</span>
</span><span id="__span-0-2">
</span><span id="__span-0-3"><span class="n">payments_bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;payments&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>PayPalAPIError</code> Exception:</strong></p>
<ul>
<li>A bespoke exception class designed for capturing and managing errors originating from the PayPal API, ensuring standardized error reporting throughout the module.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><span class="k">class</span><span class="w"> </span><span class="nc">PayPalAPIError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="__span-1-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom exception for PayPal API errors.&quot;&quot;&quot;</span>
</span><span id="__span-1-3">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">response_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-1-4">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="__span-1-5">        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
</span><span id="__span-1-6">        <span class="bp">self</span><span class="o">.</span><span class="n">response_json</span> <span class="o">=</span> <span class="n">response_json</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong>Helper Functions:</strong></p>
<ul>
<li>
<p><strong><code>get_paypal_access_token(max_retries=3, backoff_factor=0.5)</code>:</strong></p>
<ul>
<li>Retrieves an access token from the PayPal API, utilizing the client ID and secret stored in the Flask application's configuration.</li>
<li>Incorporates retry logic with exponential backoff and jitter to gracefully handle transient network-related issues.</li>
<li>Propagates a <code>PayPalAPIError</code> exception if retrieval of the access token fails after multiple attempts or if parsing the response encounters issues.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><span class="k">def</span><span class="w"> </span><span class="nf">get_paypal_access_token</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span id="__span-2-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves an access token from PayPal with retry logic.&quot;&quot;&quot;</span>
</span><span id="__span-2-3">    <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PAYPAL_SANDBOX_CLIENT_ID&#39;</span><span class="p">],</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PAYPAL_SANDBOX_CLIENT_SECRET&#39;</span><span class="p">])</span>
</span><span id="__span-2-4">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">}</span>
</span><span id="__span-2-5">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;client_credentials&#39;</span><span class="p">}</span>
</span><span id="__span-2-6">
</span><span id="__span-2-7">    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
</span><span id="__span-2-8">        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-9">            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PAYPAL_API_BASE&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/v1/oauth2/token&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-2-10">            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-2-11">            <span class="n">token_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-2-12">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PayPal Access Token Response: </span><span class="si">{</span><span class="n">token_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-13">            <span class="k">return</span> <span class="n">token_data</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">]</span>
</span><span id="__span-2-14">        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-2-15">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed to get PayPal access token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-16">            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-2-17">                <span class="n">sleep_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">))</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-2-18">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying in </span><span class="si">{</span><span class="n">sleep_duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
</span><span id="__span-2-19">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_duration</span><span class="p">)</span>
</span><span id="__span-2-20">            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-21">                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max retries reached for getting PayPal access token: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-22">                <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to get PayPal access token.&quot;</span><span class="p">)</span>
</span><span id="__span-2-23">        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-2-24">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing PayPal access token response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-25">            <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to parse PayPal access token response.&quot;</span><span class="p">)</span>
</span><span id="__span-2-26">    <span class="k">return</span> <span class="kc">None</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>create_paypal_order(amount, access_token, currency='USD')</code>:</strong></p>
<ul>
<li>Generates a PayPal order with the specified amount and currency details.</li>
<li>Implements robust error handling for potential request exceptions and response parsing failures.</li>
<li>Returns the order ID and approval URL to facilitate user authorization of the payment.</li>
<li>Raises a <code>PayPalAPIError</code> exception if the order creation encounters an issue or if response parsing fails.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><span class="k">def</span><span class="w"> </span><span class="nf">create_paypal_order</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">):</span>
</span><span id="__span-3-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a PayPal order.&quot;&quot;&quot;</span>
</span><span id="__span-3-3">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-4">        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
</span><span id="__span-3-5">        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="__span-3-6">    <span class="p">}</span>
</span><span id="__span-3-7">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-3-8">        <span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;CAPTURE&quot;</span><span class="p">,</span>
</span><span id="__span-3-9">        <span class="s2">&quot;purchase_units&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-3-10">            <span class="p">{</span>
</span><span id="__span-3-11">                <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-3-12">                    <span class="s2">&quot;currency_code&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>
</span><span id="__span-3-13">                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-3-14">                <span class="p">}</span>
</span><span id="__span-3-15">            <span class="p">}</span>
</span><span id="__span-3-16">        <span class="p">]</span>
</span><span id="__span-3-17">    <span class="p">}</span>
</span><span id="__span-3-18">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-3-19">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PAYPAL_API_BASE&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/v2/checkout/orders&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-3-20">        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-3-21">        <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-3-22">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PayPal Create Order Response: </span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-23">        <span class="n">order_id</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span><span id="__span-3-24">        <span class="n">approval_url</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;approve&#39;</span><span class="p">)</span>
</span><span id="__span-3-25">        <span class="k">return</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">approval_url</span>
</span><span id="__span-3-26">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-3-27">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating PayPal order: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-28">        <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to create PayPal order.&quot;</span><span class="p">)</span>
</span><span id="__span-3-29">    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-3-30">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing PayPal create order response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-31">        <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to parse PayPal create order response.&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>capture_paypal_order(order_id, access_token, idempotency_key=None)</code>:</strong></p>
<ul>
<li>Captures a previously authorized PayPal order.</li>
<li>Employs an <code>idempotency_key</code> to prevent accidental or malicious duplicate transactions.</li>
<li>Manages any errors that may arise during the capture process.</li>
<li>Extracts the capture ID and status from the PayPal response.</li>
<li>Raises a <code>PayPalAPIError</code> if order capturing fails or if parsing the response encounters issues.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><span class="k">def</span><span class="w"> </span><span class="nf">capture_paypal_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">idempotency_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-4-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Captures a PayPal order.&quot;&quot;&quot;</span>
</span><span id="__span-4-3">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-4">        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
</span><span id="__span-4-5">        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="__span-4-6">    <span class="p">}</span>
</span><span id="__span-4-7">    <span class="k">if</span> <span class="n">idempotency_key</span><span class="p">:</span>
</span><span id="__span-4-8">        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;PayPal-Request-Id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idempotency_key</span>
</span><span id="__span-4-9">
</span><span id="__span-4-10">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-11">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PAYPAL_API_BASE&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/v2/checkout/orders/</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s1">/capture&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="__span-4-12">        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-4-13">        <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-4-14">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PayPal Capture Order Response: </span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-15">
</span><span id="__span-4-16">        <span class="c1"># Extract capture ID and status safely</span>
</span><span id="__span-4-17">        <span class="n">purchase_units</span> <span class="o">=</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;purchase_units&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-4-18">        <span class="k">if</span> <span class="n">purchase_units</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">purchase_units</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">purchase_units</span><span class="p">:</span>
</span><span id="__span-4-19">            <span class="n">payments</span> <span class="o">=</span> <span class="n">purchase_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;payments&#39;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-4-20">            <span class="n">captures</span> <span class="o">=</span> <span class="n">payments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;captures&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-4-21">            <span class="k">if</span> <span class="n">captures</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">captures</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">captures</span><span class="p">:</span>
</span><span id="__span-4-22">                <span class="n">capture</span> <span class="o">=</span> <span class="n">captures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Assuming only one capture per purchase unit</span>
</span><span id="__span-4-23">                <span class="n">capture_id</span> <span class="o">=</span> <span class="n">capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span><span id="__span-4-24">                <span class="n">capture_status</span> <span class="o">=</span> <span class="n">capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
</span><span id="__span-4-25">                <span class="k">if</span> <span class="n">capture_id</span> <span class="ow">and</span> <span class="n">capture_status</span><span class="p">:</span>
</span><span id="__span-4-26">                    <span class="k">return</span> <span class="n">capture_status</span><span class="p">,</span> <span class="n">capture_id</span>
</span><span id="__span-4-27">
</span><span id="__span-4-28">        <span class="c1"># If any of the extractions fail, log the error and raise an exception</span>
</span><span id="__span-4-29">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract capture ID/status from PayPal response: </span><span class="si">{</span><span class="n">response_json</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-30">        <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to parse PayPal capture order response (missing capture ID/status).&quot;</span><span class="p">)</span>
</span><span id="__span-4-31">
</span><span id="__span-4-32">
</span><span id="__span-4-33">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-34">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error capturing PayPal order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-35">        <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to capture PayPal order.&quot;</span><span class="p">)</span>
</span><span id="__span-4-36">    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-37">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing PayPal capture order response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-4-38">        <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to parse PayPal capture order response.&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>get_paypal_order_details(order_id, access_token)</code>:</strong></p>
<ul>
<li>Retrieves comprehensive details regarding a specific PayPal order.</li>
<li>Includes error handling mechanisms for potential retrieval issues.</li>
<li>Raises a <code>PayPalAPIError</code> exception if retrieving order details is unsuccessful.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><span class="k">def</span><span class="w"> </span><span class="nf">get_paypal_order_details</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">access_token</span><span class="p">):</span>
</span><span id="__span-5-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets PayPal order details.&quot;&quot;&quot;</span>
</span><span id="__span-5-3">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-4">        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
</span><span id="__span-5-5">        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="__span-5-6">    <span class="p">}</span>
</span><span id="__span-5-7">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-5-8">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PAYPAL_API_BASE&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/v2/checkout/orders/</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="__span-5-9">        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-5-10">        <span class="n">order_details</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-5-11">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PayPal Order Details for </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">order_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-12">        <span class="k">return</span> <span class="n">order_details</span>
</span><span id="__span-5-13">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-5-14">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting PayPal order details for </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-5-15">        <span class="k">raise</span> <span class="n">PayPalAPIError</span><span class="p">(</span><span class="s2">&quot;Failed to get PayPal order details.&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>update_user_subscription(user, subscription)</code>:</strong></p>
<ul>
<li>Updates the user's subscription information within the database, including the subscription ID and its corresponding expiry date.</li>
<li>Implements error handling for database-related operations.</li>
<li>Raises a general <code>Exception</code> if the database update encounters any problems.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><span class="k">def</span><span class="w"> </span><span class="nf">update_user_subscription</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">subscription</span><span class="p">):</span>
</span><span id="__span-6-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the user&#39;s subscription information in the database.&quot;&quot;&quot;</span>
</span><span id="__span-6-3">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-6-4">        <span class="n">user</span><span class="o">.</span><span class="n">subscription_id</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-6-5">        <span class="n">user</span><span class="o">.</span><span class="n">subscription_expiry</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="n">subscription</span><span class="o">.</span><span class="n">validity_months</span><span class="p">)</span>
</span><span id="__span-6-6">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="c1"># add back to session so the changes can be tracked and persisted</span>
</span><span id="__span-6-7">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> subscription updated to </span><span class="si">{</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-8">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-6-9">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating user </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> subscription to </span><span class="si">{</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-6-10">        <span class="k">raise</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>record_payment(user, subscription, paypal_transaction_id)</code>:</strong></p>
<ul>
<li>Records payment-related details in the database, which includes user data, subscription details, payment amount, currency type, and the PayPal transaction ID.</li>
<li>Contains error handling mechanisms for database operations.</li>
<li>Raises a general <code>Exception</code> if payment recording fails to complete successfully.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><span class="k">def</span><span class="w"> </span><span class="nf">record_payment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">subscription</span><span class="p">,</span> <span class="n">paypal_transaction_id</span><span class="p">):</span>
</span><span id="__span-7-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Records the payment details in the database.&quot;&quot;&quot;</span>
</span><span id="__span-7-3">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-7-4">        <span class="n">payment</span> <span class="o">=</span> <span class="n">Payment</span><span class="p">(</span>
</span><span id="__span-7-5">            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-7-6">            <span class="n">payment_id</span><span class="o">=</span><span class="n">paypal_transaction_id</span><span class="p">,</span>
</span><span id="__span-7-7">            <span class="n">amount</span><span class="o">=</span><span class="n">subscription</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
</span><span id="__span-7-8">            <span class="n">currency</span><span class="o">=</span><span class="s1">&#39;USD&#39;</span><span class="p">,</span>
</span><span id="__span-7-9">            <span class="n">payment_status</span><span class="o">=</span><span class="s1">&#39;Completed&#39;</span><span class="p">,</span>
</span><span id="__span-7-10">            <span class="n">subscription_id</span><span class="o">=</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-7-11">        <span class="p">)</span>
</span><span id="__span-7-12">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span>
</span><span id="__span-7-13">        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-7-14">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payment recorded for user </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, subscription </span><span class="si">{</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, transaction </span><span class="si">{</span><span class="n">paypal_transaction_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-15">        <span class="k">return</span> <span class="n">payment</span>  <span class="c1">#Return the payment instance for payment.id access</span>
</span><span id="__span-7-16">
</span><span id="__span-7-17">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-7-18">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error recording payment for user </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, subscription </span><span class="si">{</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, transaction </span><span class="si">{</span><span class="n">paypal_transaction_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-19">        <span class="k">raise</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ul>
</li>
<li>
<p><strong>Route Handlers:</strong></p>
<ul>
<li>
<p><strong><code>@payments_bp.route('/create_paypal_order', methods=['POST'])</code> - <code>create_order()</code>:</strong></p>
<ul>
<li>Handles incoming requests aimed at creating PayPal orders.</li>
<li>Verifies the validity of the requested subscription plan.</li>
<li>Obtains a PayPal access token.</li>
<li>Initiates the creation of a PayPal order through the <code>create_paypal_order()</code> function.</li>
<li>Dispatches the approval URL to the client.</li>
<li>Manages any <code>PayPalAPIError</code> exceptions or other unexpected errors that may occur.</li>
<li>Restricts access to only logged-in users via the <code>@login_required</code> decorator.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><span class="nd">@payments_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/create_paypal_order&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span><span id="__span-8-2"><span class="nd">@login_required</span>
</span><span id="__span-8-3"><span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">():</span>
</span><span id="__span-8-4">    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
</span><span id="__span-8-5">    <span class="n">plan</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plan&#39;</span><span class="p">)</span>
</span><span id="__span-8-6">    <span class="n">valid_plans</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pro&#39;</span><span class="p">,</span> <span class="s1">&#39;premium&#39;</span><span class="p">]</span>
</span><span id="__span-8-7">
</span><span id="__span-8-8">    <span class="k">if</span> <span class="ow">not</span> <span class="n">plan</span> <span class="ow">or</span> <span class="n">plan</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_plans</span><span class="p">:</span>
</span><span id="__span-8-9">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid plan requested: </span><span class="si">{</span><span class="n">plan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-8-10">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid request.&#39;</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-8-11">
</span><span id="__span-8-12">    <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">plan_name</span><span class="o">=</span><span class="n">plan</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; Security&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="__span-8-13">    <span class="k">if</span> <span class="ow">not</span> <span class="n">subscription</span><span class="p">:</span>
</span><span id="__span-8-14">        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Create order request for invalid plan: </span><span class="si">{</span><span class="n">plan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-8-15">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid request.&#39;</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="__span-8-16">
</span><span id="__span-8-17">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-8-18">        <span class="n">access_token</span> <span class="o">=</span> <span class="n">get_paypal_access_token</span><span class="p">()</span>
</span><span id="__span-8-19">        <span class="n">order_id</span><span class="p">,</span> <span class="n">approval_url</span> <span class="o">=</span> <span class="n">create_paypal_order</span><span class="p">(</span><span class="n">subscription</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> <span class="n">access_token</span><span class="p">)</span>
</span><span id="__span-8-20">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;approval_url&#39;</span><span class="p">:</span> <span class="n">approval_url</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">}),</span> <span class="mi">200</span>
</span><span id="__span-8-21">    <span class="k">except</span> <span class="n">PayPalAPIError</span><span class="p">:</span>
</span><span id="__span-8-22">        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;There was an error creating the payment. Please try again.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-8-23">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Payment creation failed.&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="__span-8-24">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-8-25">        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in create_order: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-8-26">        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;There was an unexpected error. Please try again later.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-8-27">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Payment creation failed.&#39;</span><span class="p">}),</span> <span class="mi">500</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>@payments_bp.route('/capture_paypal_order', methods=['GET'])</code> - <code>capture_order()</code>:</strong></p>
<ul>
<li>Handles requests to capture a PayPal order after the user has authorized the payment.</li>
<li>Retrieves the order ID and plan name from the request parameters.</li>
<li>Retrieves a PayPal access token.</li>
<li>Gets the order details using <code>get_paypal_order_details()</code>.</li>
<li>Handles <code>PAYER_ACTION_REQUIRED</code> status by redirecting the user to PayPal for further action.</li>
<li>Captures the PayPal order using the <code>capture_paypal_order()</code> function, including an idempotency key.</li>
<li>Updates the user's subscription in the database using <code>update_user_subscription()</code>.</li>
<li>Records the payment details in the database using <code>record_payment()</code>.</li>
<li>Redirects the user to a payment success page.</li>
<li>Includes comprehensive error handling and logging.</li>
<li>Requires the user to be logged in (<code>@login_required</code>).</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><span class="nd">@payments_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/capture_paypal_order&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
</span><span id="__span-9-2"><span class="nd">@login_required</span>
</span><span id="__span-9-3"><span class="k">def</span><span class="w"> </span><span class="nf">capture_order</span><span class="p">():</span>
</span><span id="__span-9-4">    <span class="n">order_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
</span><span id="__span-9-5">    <span class="n">plan_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plan&#39;</span><span class="p">)</span>
</span><span id="__span-9-6">
</span><span id="__span-9-7">    <span class="k">if</span> <span class="ow">not</span> <span class="n">order_id</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">plan_name</span><span class="p">:</span>
</span><span id="__span-9-8">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Invalid payment request.&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span><span id="__span-9-9">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">))</span>
</span><span id="__span-9-10">
</span><span id="__span-9-11">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-12">        <span class="n">access_token</span> <span class="o">=</span> <span class="n">get_paypal_access_token</span><span class="p">()</span>
</span><span id="__span-9-13">        <span class="n">order_details</span> <span class="o">=</span> <span class="n">get_paypal_order_details</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">access_token</span><span class="p">)</span>
</span><span id="__span-9-14">        <span class="n">order_status</span> <span class="o">=</span> <span class="n">order_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
</span><span id="__span-9-15">
</span><span id="__span-9-16">        <span class="c1"># Handle PAYER_ACTION_REQUIRED by redirecting</span>
</span><span id="__span-9-17">        <span class="k">if</span> <span class="n">order_status</span> <span class="o">==</span> <span class="s1">&#39;PAYER_ACTION_REQUIRED&#39;</span><span class="p">:</span>
</span><span id="__span-9-18">            <span class="n">payer_action_url</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">link</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">order_details</span><span class="p">[</span><span class="s1">&#39;links&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">link</span><span class="p">[</span><span class="s1">&#39;rel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;payer-action&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="__span-9-19">            <span class="k">if</span> <span class="n">payer_action_url</span><span class="p">:</span>
</span><span id="__span-9-20">                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">payer_action_url</span><span class="p">)</span>
</span><span id="__span-9-21">            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-9-22">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2"> requires payer action, but no &#39;payer-action&#39; link found.&quot;</span><span class="p">)</span>
</span><span id="__span-9-23">                <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Payment requires additional action on PayPal. Please check your PayPal account.&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span><span id="__span-9-24">                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">))</span>
</span><span id="__span-9-25">
</span><span id="__span-9-26">        <span class="c1"># Proceed with capture only if the order is APPROVED</span>
</span><span id="__span-9-27">        <span class="k">if</span> <span class="n">order_status</span> <span class="o">!=</span> <span class="s1">&#39;APPROVED&#39;</span><span class="p">:</span>
</span><span id="__span-9-28">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2"> is not in a capturable state: </span><span class="si">{</span><span class="n">order_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-29">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Payment cannot be completed at this time. Please try again later.&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span><span id="__span-9-30">            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">))</span>
</span><span id="__span-9-31">
</span><span id="__span-9-32">        <span class="n">paypal_request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>  <span class="c1"># Generate UUID for idempotency</span>
</span><span id="__span-9-33">        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-34">            <span class="n">capture_status</span><span class="p">,</span> <span class="n">paypal_capture_id</span> <span class="o">=</span> <span class="n">capture_paypal_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">paypal_request_id</span><span class="p">)</span>
</span><span id="__span-9-35">        <span class="k">except</span> <span class="n">PayPalAPIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-36">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Capture failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-37">            <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;There was an error capturing the payment. Please try again or contact support.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-9-38">            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">)})</span>
</span><span id="__span-9-39">
</span><span id="__span-9-40">        <span class="k">if</span> <span class="n">capture_status</span> <span class="o">==</span> <span class="s1">&#39;COMPLETED&#39;</span><span class="p">:</span>
</span><span id="__span-9-41">            <span class="n">subscription</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">plan_name</span><span class="o">=</span><span class="n">plan_name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; Security&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="__span-9-42">            <span class="k">if</span> <span class="ow">not</span> <span class="n">subscription</span><span class="p">:</span>
</span><span id="__span-9-43">                <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Error: Invalid plan during payment completion.&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span><span id="__span-9-44">                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.scan&#39;</span><span class="p">)})</span>
</span><span id="__span-9-45">
</span><span id="__span-9-46">            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-9-47">                <span class="c1"># Validation and Logging</span>
</span><span id="__span-9-48">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to update subscription for user </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, subscription </span><span class="si">{</span><span class="n">subscription</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, paypal_capture_id </span><span class="si">{</span><span class="n">paypal_capture_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-49">
</span><span id="__span-9-50">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paypal_capture_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">paypal_capture_id</span><span class="p">:</span>
</span><span id="__span-9-51">                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid paypal_capture_id: </span><span class="si">{</span><span class="n">paypal_capture_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-52">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid paypal_capture_id&quot;</span><span class="p">)</span>
</span><span id="__span-9-53">
</span><span id="__span-9-54">                <span class="n">update_user_subscription</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">subscription</span><span class="p">)</span>
</span><span id="__span-9-55">                <span class="n">payment</span> <span class="o">=</span> <span class="n">record_payment</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">subscription</span><span class="p">,</span> <span class="n">paypal_capture_id</span><span class="p">)</span>
</span><span id="__span-9-56">
</span><span id="__span-9-57">
</span><span id="__span-9-58">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subscription updated and payment recorded successfully for user </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-59">
</span><span id="__span-9-60">                <span class="c1"># Payment successful, redirect to success page</span>
</span><span id="__span-9-61">                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
</span><span id="__span-9-62">                    <span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;payments.payment_successful&#39;</span><span class="p">,</span> <span class="n">payment_id</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="__span-9-63">                <span class="p">})</span>
</span><span id="__span-9-64">
</span><span id="__span-9-65">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-66">                <span class="c1">#In automatic transaction mode, we must manually call rollback</span>
</span><span id="__span-9-67">                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="__span-9-68">                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing payment for user </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Log full traceback</span>
</span><span id="__span-9-69">                <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;An error occurred while updating your subscription. Please contact support.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-9-70">                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">)})</span>
</span><span id="__span-9-71">
</span><span id="__span-9-72">        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-9-73">            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PayPal Capture failed for order </span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">, status </span><span class="si">{</span><span class="n">capture_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-74">            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Payment failed or was not completed.&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span>
</span><span id="__span-9-75">            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">)})</span>
</span><span id="__span-9-76">
</span><span id="__span-9-77">    <span class="k">except</span> <span class="n">PayPalAPIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-78">         <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There was an error processing your payment: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-9-79">         <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">)})</span>
</span><span id="__span-9-80">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-9-81">        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error in capture_order: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-9-82">        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;There was an unexpected error during payment processing.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-9-83">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;redirect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">)})</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>@payments_bp.route('/cancel_paypal_order')</code> - <code>cancel_order()</code>:</strong></p>
<ul>
<li>Manages scenarios where the user cancels their PayPal payment.</li>
<li>Presents a flash message to inform the user that the payment has been canceled.</li>
<li>Redirects the user back to the pricing page.</li>
<li>This route is restricted to authenticated users only via the <code>@login_required</code> decorator.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><span class="nd">@payments_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/cancel_paypal_order&#39;</span><span class="p">)</span>
</span><span id="__span-10-2"><span class="nd">@login_required</span>
</span><span id="__span-10-3"><span class="k">def</span><span class="w"> </span><span class="nf">cancel_order</span><span class="p">():</span>
</span><span id="__span-10-4">    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Payment was canceled by the user.&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span><span id="__span-10-5">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.pricing&#39;</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
</li>
<li>
<p><strong><code>@payments_bp.route('/payment_successful/&lt;int:payment_id&gt;')</code> - <code>payment_successful()</code>:</strong></p>
<ul>
<li>Renders the payment confirmation page after a successful transaction, displaying relevant payment details.</li>
<li>Retrieves the payment information from the database based on the provided payment ID.</li>
<li>Validates that the payment corresponds to the currently logged-in user, preventing unauthorized access.</li>
<li>Returns a 404 error if the specified payment cannot be located.</li>
<li>Requires user authentication using the <code>@login_required</code> decorator.</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><span class="nd">@payments_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/payment_successful/&lt;int:payment_id&gt;&#39;</span><span class="p">)</span>
</span><span id="__span-11-2"><span class="nd">@login_required</span>
</span><span id="__span-11-3"><span class="k">def</span><span class="w"> </span><span class="nf">payment_successful</span><span class="p">(</span><span class="n">payment_id</span><span class="p">):</span>
</span><span id="__span-11-4"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Renders the payment successful page with payment details.&quot;&quot;&quot;</span>
</span><span id="__span-11-5">    <span class="n">payment</span> <span class="o">=</span> <span class="n">Payment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">payment_id</span><span class="p">)</span>
</span><span id="__span-11-6">    <span class="k">if</span> <span class="n">payment</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
</span><span id="__span-11-7">        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;You are not authorized to view this payment.&quot;</span><span class="p">,</span> <span class="s2">&quot;danger&quot;</span><span class="p">)</span>
</span><span id="__span-11-8">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;main.home&#39;</span><span class="p">))</span>  <span class="c1"># Or appropriate error page</span>
</span><span id="__span-11-9">
</span><span id="__span-11-10">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;payment_successful.html&#39;</span><span class="p">,</span> <span class="n">payment</span><span class="o">=</span><span class="n">payment</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ul>
</li>
</ul>
<p><strong>Dependencies:</strong></p>
<ul>
<li><code>flask</code>: Powers the Blueprint, manages HTTP requests, renders templates, and provides access to application configuration settings.</li>
<li><code>flask_login</code>: Enforces user authentication and authorization protocols.</li>
<li><code>app.extensions</code>: Grants access to the database instance (<code>db</code>).</li>
<li><code>app.models</code>: Specifies data models representing <code>Subscription</code>, <code>Payment</code>, and <code>User</code> entities.</li>
<li><code>datetime</code>: Facilitates working with date and time values.</li>
<li><code>os</code>: Used to access environment variables.</li>
<li><code>requests</code>: Enables making HTTP requests to interact with the PayPal API.</li>
<li><code>logging</code>: Provides a mechanism for logging errors and debugging information.</li>
<li><code>uuid</code>: Generates universally unique identifiers (UUIDs) for idempotency purposes.</li>
<li><code>time</code>: Facilitates the implementation of delays in retry logic.</li>
<li><code>random</code>: Introduces randomness or "jitter" into retry delays to avoid synchronized retries.</li>
<li><code>sqlalchemy.exc</code>: Allows for handling exceptions related to SQLAlchemy database operations.</li>
</ul>
<p><strong>Configuration:</strong></p>
<p>The following configuration variables are essential for proper operation:</p>
<ul>
<li><code>PAYPAL_SANDBOX_CLIENT_ID</code>: The PayPal client ID designated for the sandbox testing environment.</li>
<li><code>PAYPAL_SANDBOX_CLIENT_SECRET</code>: The PayPal client secret associated with the sandbox environment.</li>
<li><code>PAYPAL_API_BASE</code>: The base URL for accessing the PayPal API (e.g., <code>https://api-m.sandbox.paypal.com</code>).</li>
</ul>
<p>These configuration parameters should be accurately defined within the Flask application's configuration settings.</p>
<p><strong>Error Handling:</strong></p>
<ul>
<li>A specialized <code>PayPalAPIError</code> exception is used to handle errors specifically related to the PayPal API interactions.</li>
<li>Retry mechanisms with exponential backoff and jitter are implemented when attempting to retrieve PayPal access tokens.</li>
<li>Comprehensive error handling is incorporated into each function, which involves logging, displaying user-friendly flash messages, and redirecting users as needed.</li>
<li>Database operations are enclosed within try-except blocks to handle and manage potential exceptions gracefully.</li>
</ul>
<p><strong>Security Considerations:</strong></p>
<ul>
<li>The PayPal client ID and secret are highly sensitive credentials and must be protected diligently. Avoid hardcoding these credentials directly into the source code. Instead, use environment variables or a secure secrets management system to store and retrieve them.</li>
<li>Input validation is conducted to mitigate the risk of malicious requests and potential security vulnerabilities.</li>
<li>User authorization is rigorously enforced through the <code>@login_required</code> decorator, ensuring that only authenticated users can access payment-related functionalities.</li>
<li>The <code>idempotency_key</code> plays a critical role in preventing duplicate transactions, thereby enhancing the system's reliability and preventing accidental charges.</li>
<li>Database transactions are rolled back automatically whenever an error occurs to maintain data integrity and consistency.</li>
<li>The payment capture logic incorporates a validation step to confirm that the order is in the <code>APPROVED</code> state before proceeding with the capture operation. Additionally, the system handles the <code>PAYER_ACTION_REQUIRED</code> status by redirecting the user to PayPal to complete any necessary verification or authorization steps.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>