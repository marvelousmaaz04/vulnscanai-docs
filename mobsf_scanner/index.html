
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../zap_scanner/">
      
      
        <link rel="next" href="../sqlmap_scanner/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>MobSF Scanner - VulnScanAI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mobsf-scanner" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="VulnScanAI Documentation" class="md-header__button md-logo" aria-label="VulnScanAI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            VulnScanAI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MobSF Scanner
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="VulnScanAI Documentation" class="md-nav__button md-logo" aria-label="VulnScanAI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    VulnScanAI Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../toc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Table of Contents
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    App Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            App Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Scanners Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Scanners Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scanners/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nmap_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nmap Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nikto_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nikto Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zap_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ZAP Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    MobSF Scanner
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    MobSF Scanner
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-get_mobsf_report_directory" class="md-nav__link">
    <span class="md-ellipsis">
      1. get_mobsf_report_directory()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-upload_and_analyzeapp_file-api_url-api_key" class="md-nav__link">
    <span class="md-ellipsis">
      2. upload_and_analyze(app_file, api_url, api_key)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-initiate_scanfile_hash-api_url-api_key" class="md-nav__link">
    <span class="md-ellipsis">
      3. initiate_scan(file_hash, api_url, api_key)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-fetch_and_save_pdf_reportfile_hash-api_url-api_key-user_id-original_filename" class="md-nav__link">
    <span class="md-ellipsis">
      4. fetch_and_save_pdf_report(file_hash, api_url, api_key, user_id, original_filename)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sqlmap_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SQLMap Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ssl_scanner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SSL Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prowler_scanner_aws/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prowler AWS Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prowler_scanner_gcp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prowler GCP Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudsploit_scanner_azure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CloudSploit Azure Scanner
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Views Directory
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Views Directory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../views/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-get_mobsf_report_directory" class="md-nav__link">
    <span class="md-ellipsis">
      1. get_mobsf_report_directory()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-upload_and_analyzeapp_file-api_url-api_key" class="md-nav__link">
    <span class="md-ellipsis">
      2. upload_and_analyze(app_file, api_url, api_key)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-initiate_scanfile_hash-api_url-api_key" class="md-nav__link">
    <span class="md-ellipsis">
      3. initiate_scan(file_hash, api_url, api_key)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-fetch_and_save_pdf_reportfile_hash-api_url-api_key-user_id-original_filename" class="md-nav__link">
    <span class="md-ellipsis">
      4. fetch_and_save_pdf_report(file_hash, api_url, api_key, user_id, original_filename)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset"><a class="md-content__button md-icon" download href="../pdf/combined.pdf" title="PDF Export"><svg style="height: 1.2rem; width: 1.2rem;" viewBox="0 0 384 512" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm76.45 211.36l-96.42 95.7c-6.65 6.61-17.39 6.61-24.04 0l-96.42-95.7C73.42 337.29 80.54 320 94.82 320H160v-80c0-8.84 7.16-16 16-16h32c8.84 0 16 7.16 16 16v80h65.18c14.28 0 21.4 17.29 11.27 27.36zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z"></path></svg></a>
                
                  



<h1 id="mobsf-scanner">MobSF Scanner</h1>
<p>This document details the functionality of the <code>mobsf_scanner.py</code> script, which automates mobile application security assessments using MobSF (Mobile Security Framework). The script provides functions to upload and analyze an application, fetch the generated PDF report, and customize the first page with a company logo.</p>
<h2 id="overview">Overview</h2>
<p>The script performs the following steps:</p>
<ol>
<li><strong>Defines Report Directory:</strong> Establishes the directory for storing MobSF reports.</li>
<li><strong>Uploads and Analyzes App:</strong> Uploads the provided application file to the MobSF API for analysis.</li>
<li><strong>Fetches and Customizes PDF Report:</strong> Downloads the generated PDF report from MobSF, adds a company logo and title to the first page using <code>PyMuPDF</code>, and removes the original first page.</li>
<li><strong>Returns Report Filename:</strong> Returns the filename of the generated PDF report.</li>
</ol>
<h2 id="functions">Functions</h2>
<h3 id="1-get_mobsf_report_directory">1. <code>get_mobsf_report_directory()</code></h3>
<ul>
<li>
<p><strong>Purpose:</strong> Determines and creates the directory where MobSF reports will be stored.</p>
</li>
<li>
<p><strong>Functionality:</strong></p>
<ul>
<li>Defines the base directory path as <code>reports/mobsf</code> within the Flask application's root directory.</li>
<li>Uses <code>os.makedirs(report_dir_base, exist_ok=True)</code> to create the directory if it doesn't exist.</li>
</ul>
</li>
<li>
<p><strong>Code Snippet:</strong></p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-0-2"><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_app</span>
</span><span id="__span-0-3">
</span><span id="__span-0-4"><span class="k">def</span><span class="w"> </span><span class="nf">get_mobsf_report_directory</span><span class="p">():</span>
</span><span id="__span-0-5">    <span class="n">report_dir_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;reports&#39;</span><span class="p">,</span> <span class="s1">&#39;mobsf&#39;</span><span class="p">)</span>
</span><span id="__span-0-6">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">report_dir_base</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-0-7">    <span class="k">return</span> <span class="n">report_dir_base</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ul>
<h3 id="2-upload_and_analyzeapp_file-api_url-api_key">2. <code>upload_and_analyze(app_file, api_url, api_key)</code></h3>
<ul>
<li>
<p><strong>Purpose:</strong> Uploads the mobile app file to the MobSF API and initiates the analysis.</p>
</li>
<li>
<p><strong>Functionality:</strong></p>
<ul>
<li>Constructs the upload URL using the provided <code>api_url</code>.</li>
<li>Sets the <code>Authorization</code> header with the <code>api_key</code>.</li>
<li>Creates a <code>files</code> dictionary containing the application file details (filename, stream, content type).</li>
<li>Uses <code>requests.post()</code> to upload the file to MobSF.</li>
<li>Parses the JSON response to check for a successful upload.</li>
<li>If the upload is successful, it extracts the file hash and calls <code>initiate_scan()</code> to start the analysis.</li>
<li>Returns the file hash if the upload and scan initiation are successful, otherwise returns <code>None</code>.</li>
<li>Includes exception handling for network-related errors.</li>
</ul>
</li>
<li>
<p><strong>Code Snippet:</strong></p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="__span-1-2">
</span><span id="__span-1-3"><span class="k">def</span><span class="w"> </span><span class="nf">upload_and_analyze</span><span class="p">(</span><span class="n">app_file</span><span class="p">,</span> <span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
</span><span id="__span-1-4">    <span class="n">upload_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/upload&quot;</span>
</span><span id="__span-1-5">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span>
</span><span id="__span-1-6">    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">app_file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">app_file</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">app_file</span><span class="o">.</span><span class="n">content_type</span><span class="p">)}</span>
</span><span id="__span-1-7">
</span><span id="__span-1-8">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-1-9">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">upload_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
</span><span id="__span-1-10">        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-1-11">        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-1-12">        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
</span><span id="__span-1-13">            <span class="n">file_hash</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">)</span>
</span><span id="__span-1-14">            <span class="k">if</span> <span class="n">file_hash</span><span class="p">:</span>
</span><span id="__span-1-15">                <span class="k">if</span> <span class="n">initiate_scan</span><span class="p">(</span><span class="n">file_hash</span><span class="p">,</span> <span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
</span><span id="__span-1-16">                    <span class="k">return</span> <span class="n">file_hash</span>
</span><span id="__span-1-17">                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-18">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MobSF Error: Failed to initiate scan for hash </span><span class="si">{</span><span class="n">file_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-19">                    <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-1-20">            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-21">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MobSF Error: Missing hash in upload response: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-22">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-1-23">        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-1-24">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MobSF Upload Error: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-25">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-1-26">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-1-27">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error communicating with MobSF API (upload): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-1-28">        <span class="k">return</span> <span class="kc">None</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ul>
<h3 id="3-initiate_scanfile_hash-api_url-api_key">3. <code>initiate_scan(file_hash, api_url, api_key)</code></h3>
<ul>
<li>
<p><strong>Purpose:</strong> Initiates the MobSF scan for a previously uploaded file.</p>
</li>
<li>
<p><strong>Functionality:</strong></p>
<ul>
<li>Constructs the scan URL using the provided <code>api_url</code>.</li>
<li>Sets the <code>Authorization</code> header with the <code>api_key</code>.</li>
<li>Creates a <code>data</code> dictionary containing the file hash and scan type (assumes APK, but can be adjusted).</li>
<li>Uses <code>requests.post()</code> to initiate the scan.</li>
<li>Parses the JSON response to check for a successful scan initiation by confirming the existence of <code>title</code> key which determines the success</li>
<li>Returns <code>True</code> if the scan initiation is successful, otherwise returns <code>False</code>.</li>
<li>Includes exception handling for network-related errors.</li>
</ul>
</li>
<li>
<p><strong>Code Snippet:</strong></p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="__span-2-2">
</span><span id="__span-2-3"><span class="k">def</span><span class="w"> </span><span class="nf">initiate_scan</span><span class="p">(</span><span class="n">file_hash</span><span class="p">,</span> <span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
</span><span id="__span-2-4">    <span class="n">scan_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/scan&quot;</span>
</span><span id="__span-2-5">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span>
</span><span id="__span-2-6">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">,</span> <span class="s2">&quot;scan_type&quot;</span><span class="p">:</span> <span class="s2">&quot;apk&quot;</span><span class="p">}</span> <span class="c1"># Assuming APK, adjust if needed</span>
</span><span id="__span-2-7">
</span><span id="__span-2-8">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-2-9">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">scan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span id="__span-2-10">        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-2-11">        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-2-12">        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">):</span>
</span><span id="__span-2-13">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MobSF Scan initiated successfully for hash: </span><span class="si">{</span><span class="n">file_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-14">            <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-2-15">        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-2-16">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MobSF Scan Initiation Error: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-17">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-2-18">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-2-19">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error communicating with MobSF API (scan): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-20">        <span class="k">return</span> <span class="kc">False</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ul>
<h3 id="4-fetch_and_save_pdf_reportfile_hash-api_url-api_key-user_id-original_filename">4. <code>fetch_and_save_pdf_report(file_hash, api_url, api_key, user_id, original_filename)</code></h3>
<ul>
<li>
<p><strong>Purpose:</strong> Fetches the PDF report from the MobSF API and replaces the first page with a custom-generated one.</p>
</li>
<li>
<p><strong>Functionality:</strong></p>
<ul>
<li>Constructs the PDF download URL using the provided <code>api_url</code>.</li>
<li>Sets the <code>Authorization</code> header with the <code>api_key</code>.</li>
<li>Creates a <code>data</code> dictionary containing the file hash.</li>
<li>Uses <code>requests.post()</code> with <code>stream=True</code> to download the PDF report.</li>
<li>Opens the PDF report using <code>fitz.open()</code>.</li>
<li>Dynamically determine the report type based on file type.</li>
<li>Creates a new page with company logo and mobile app title on the upper half and copies the lower half of the original mobsf report to the lower half of the new page, replacing the default MobSF first page with the custom content.</li>
<li>Saves the modified PDF report to the reports directory with a unique filename.</li>
<li>Returns the filename of the saved PDF report, or <code>None</code> on failure.</li>
<li>Includes exception handling for network-related errors and PDF processing errors.</li>
</ul>
</li>
<li>
<p><strong>Code Snippet:</strong></p>
<div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="__span-3-2"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-3-3"><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-3-4"><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_app</span>
</span><span id="__span-3-5"><span class="kn">import</span><span class="w"> </span><span class="nn">fitz</span>  <span class="c1"># PyMuPDF</span>
</span><span id="__span-3-6">
</span><span id="__span-3-7"><span class="k">def</span><span class="w"> </span><span class="nf">fetch_and_save_pdf_report</span><span class="p">(</span><span class="n">file_hash</span><span class="p">,</span> <span class="n">api_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">original_filename</span><span class="p">):</span>
</span><span id="__span-3-8">    <span class="n">pdf_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">/api/v1/download_pdf&quot;</span>
</span><span id="__span-3-9">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span>
</span><span id="__span-3-10">    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">}</span>
</span><span id="__span-3-11">
</span><span id="__span-3-12">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-3-13">        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-14">        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-3-15">
</span><span id="__span-3-16">        <span class="n">pdf_bytes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-3-17">        <span class="n">pdf_doc</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">pdf_bytes</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
</span><span id="__span-3-18">
</span><span id="__span-3-19">        <span class="c1"># Get dimensions of existing page</span>
</span><span id="__span-3-20">        <span class="n">page_width</span> <span class="o">=</span> <span class="n">pdf_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">width</span>
</span><span id="__span-3-21">        <span class="n">page_height</span> <span class="o">=</span> <span class="n">pdf_doc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span>
</span><span id="__span-3-22">
</span><span id="__span-3-23">        <span class="c1"># Create a new page and insert it at the beginning (index 0), replacing the old one</span>
</span><span id="__span-3-24">        <span class="n">pdf_doc</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="n">pno</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">page_width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">page_height</span><span class="p">)</span>
</span><span id="__span-3-25">
</span><span id="__span-3-26">        <span class="c1"># Get new page</span>
</span><span id="__span-3-27">        <span class="n">new_page</span><span class="o">=</span> <span class="n">pdf_doc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-3-28">
</span><span id="__span-3-29">        <span class="c1"># --- Add dark gray background to the ENTIRE page ---</span>
</span><span id="__span-3-30">        <span class="n">full_page_rect</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_width</span><span class="p">,</span> <span class="n">page_height</span><span class="p">)</span>
</span><span id="__span-3-31">
</span><span id="__span-3-32">        <span class="c1"># White color</span>
</span><span id="__span-3-33">        <span class="n">gray_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-3-34">        <span class="n">new_page</span><span class="o">.</span><span class="n">draw_rect</span><span class="p">(</span><span class="n">full_page_rect</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">gray_color</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">gray_color</span><span class="p">)</span>
</span><span id="__span-3-35">
</span><span id="__span-3-36">        <span class="c1"># --- Create the UPPER HALF of the new first page ---</span>
</span><span id="__span-3-37">        <span class="n">logo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">,</span> <span class="s1">&#39;company_logo.PNG&#39;</span><span class="p">)</span>
</span><span id="__span-3-38">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logo_path</span><span class="p">):</span>
</span><span id="__span-3-39">            <span class="n">logo</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Pixmap</span><span class="p">(</span><span class="n">logo_path</span><span class="p">)</span>
</span><span id="__span-3-40">            <span class="n">logo_width_pt</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="__span-3-41">            <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">logo</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">logo</span><span class="o">.</span><span class="n">height</span>
</span><span id="__span-3-42">            <span class="n">logo_height_pt</span> <span class="o">=</span> <span class="n">logo_width_pt</span> <span class="o">/</span> <span class="n">aspect_ratio</span>
</span><span id="__span-3-43">
</span><span id="__span-3-44">            <span class="c1"># Center the logo at the top of the page</span>
</span><span id="__span-3-45">            <span class="n">logo_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_width</span> <span class="o">-</span> <span class="n">logo_width_pt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="__span-3-46">            <span class="n">logo_y</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="__span-3-47">
</span><span id="__span-3-48">            <span class="n">logo_rect</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="n">logo_x</span><span class="p">,</span> <span class="n">logo_y</span><span class="p">,</span> <span class="n">logo_x</span> <span class="o">+</span> <span class="n">logo_width_pt</span><span class="p">,</span> <span class="n">logo_y</span> <span class="o">+</span> <span class="n">logo_height_pt</span><span class="p">)</span>
</span><span id="__span-3-49">
</span><span id="__span-3-50">            <span class="n">new_page</span><span class="o">.</span><span class="n">insert_image</span><span class="p">(</span><span class="n">logo_rect</span><span class="p">,</span> <span class="n">pixmap</span><span class="o">=</span><span class="n">logo</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-51">        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-52">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Logo not found at </span><span class="si">{</span><span class="n">logo_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-53">
</span><span id="__span-3-54">        <span class="c1"># Load the font file</span>
</span><span id="__span-3-55">        <span class="n">font_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;fonts&#39;</span><span class="p">,</span> <span class="s1">&#39;Montserrat-Medium.ttf&#39;</span><span class="p">)</span>
</span><span id="__span-3-56">
</span><span id="__span-3-57">        <span class="c1"># Check if the font file exists</span>
</span><span id="__span-3-58">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">font_file</span><span class="p">):</span>
</span><span id="__span-3-59">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Font file not found at </span><span class="si">{</span><span class="n">font_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-60">            <span class="n">font_name</span> <span class="o">=</span> <span class="s2">&quot;Helvetica-Bold&quot;</span> <span class="c1"># Fallback to a standard font</span>
</span><span id="__span-3-61">
</span><span id="__span-3-62">
</span><span id="__span-3-63">        <span class="c1"># Determine the report type</span>
</span><span id="__span-3-64">        <span class="k">if</span> <span class="n">original_filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.apk&#39;</span><span class="p">)):</span>
</span><span id="__span-3-65">            <span class="n">report_type</span> <span class="o">=</span> <span class="s2">&quot;ANDROID&quot;</span>
</span><span id="__span-3-66">        <span class="k">elif</span> <span class="n">original_filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.ipa&#39;</span><span class="p">)):</span>
</span><span id="__span-3-67">            <span class="n">report_type</span> <span class="o">=</span> <span class="s2">&quot;IOS&quot;</span>
</span><span id="__span-3-68">        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-69">            <span class="n">report_type</span> <span class="o">=</span> <span class="s2">&quot;MOBILE&quot;</span>
</span><span id="__span-3-70">
</span><span id="__span-3-71">        <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_type</span><span class="si">}</span><span class="s2"> STATIC ANALYSIS REPORT&quot;</span>
</span><span id="__span-3-72">        <span class="n">title_font_size</span> <span class="o">=</span> <span class="mi">28</span>
</span><span id="__span-3-73">        <span class="n">title_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-74">
</span><span id="__span-3-75">        <span class="c1"># Calculate text width using the font file</span>
</span><span id="__span-3-76">        <span class="n">text_width</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">get_text_length</span><span class="p">(</span><span class="n">title_text</span><span class="p">,</span> <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;helvetica-bold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">title_font_size</span><span class="p">)</span>
</span><span id="__span-3-77">        <span class="n">text_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_width</span> <span class="o">-</span> <span class="n">text_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="__span-3-78">        <span class="n">text_y</span> <span class="o">=</span> <span class="n">logo_y</span> <span class="o">+</span> <span class="n">logo_height_pt</span> <span class="o">+</span> <span class="mi">30</span>
</span><span id="__span-3-79">
</span><span id="__span-3-80">        <span class="c1"># Insert the title text</span>
</span><span id="__span-3-81">        <span class="n">new_page</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span>
</span><span id="__span-3-82">            <span class="p">(</span><span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">),</span>
</span><span id="__span-3-83">            <span class="n">title_text</span><span class="p">,</span>
</span><span id="__span-3-84">            <span class="n">fontname</span><span class="o">=</span><span class="s1">&#39;helvetica-bold&#39;</span><span class="p">,</span>  <span class="c1"># Use the font name assigned</span>
</span><span id="__span-3-85">            <span class="n">fontsize</span><span class="o">=</span><span class="n">title_font_size</span><span class="p">,</span>
</span><span id="__span-3-86">            <span class="n">color</span><span class="o">=</span><span class="n">title_color</span>
</span><span id="__span-3-87">        <span class="p">)</span>
</span><span id="__span-3-88">
</span><span id="__span-3-89">        <span class="c1"># --- Copy the LOWER HALF of the original MobSF first page ---</span>
</span><span id="__span-3-90">        <span class="c1"># Define the rectangle to copy from the original page</span>
</span><span id="__span-3-91">        <span class="n">source_rect</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">page_width</span><span class="p">,</span> <span class="n">page_height</span><span class="p">)</span>
</span><span id="__span-3-92">
</span><span id="__span-3-93">        <span class="c1"># Create a temporary PDF document containing only the first page</span>
</span><span id="__span-3-94">        <span class="n">temp_pdf</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</span><span id="__span-3-95">        <span class="n">temp_page</span> <span class="o">=</span> <span class="n">temp_pdf</span><span class="o">.</span><span class="n">new_page</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">page_width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">page_height</span><span class="p">)</span>
</span><span id="__span-3-96">        <span class="n">temp_page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span><span class="n">temp_page</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">pdf_doc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-97">
</span><span id="__span-3-98">        <span class="c1"># Define the target rectangle on the new page for the lower half</span>
</span><span id="__span-3-99">        <span class="n">target_rect</span> <span class="o">=</span> <span class="n">fitz</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">page_width</span><span class="p">,</span> <span class="n">page_height</span><span class="p">)</span>
</span><span id="__span-3-100">
</span><span id="__span-3-101">        <span class="c1"># Insert the area into the new page from the temp PDF, using target_rect</span>
</span><span id="__span-3-102">        <span class="n">new_page</span><span class="o">.</span><span class="n">show_pdf_page</span><span class="p">(</span><span class="n">target_rect</span><span class="p">,</span> <span class="n">temp_pdf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="n">source_rect</span><span class="p">)</span>
</span><span id="__span-3-103">
</span><span id="__span-3-104">        <span class="c1"># Delete the original first page (now at position 0)</span>
</span><span id="__span-3-105">        <span class="n">pdf_doc</span><span class="o">.</span><span class="n">delete_page</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-106">
</span><span id="__span-3-107">        <span class="c1">#Close temporary pdf doc</span>
</span><span id="__span-3-108">        <span class="n">temp_pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-3-109">
</span><span id="__span-3-110">        <span class="c1"># --- Save the modified PDF ---</span>
</span><span id="__span-3-111">        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
</span><span id="__span-3-112">        <span class="n">report_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_mobsf_</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">original_filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
</span><span id="__span-3-113">        <span class="n">report_dir</span> <span class="o">=</span> <span class="n">get_mobsf_report_directory</span><span class="p">()</span>
</span><span id="__span-3-114">        <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_dir</span><span class="p">,</span> <span class="n">report_filename</span><span class="p">)</span>
</span><span id="__span-3-115">        <span class="n">pdf_doc</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">)</span>
</span><span id="__span-3-116">        <span class="n">pdf_doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="__span-3-117">
</span><span id="__span-3-118">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">report_filename</span><span class="p">)</span>
</span><span id="__span-3-119">
</span><span id="__span-3-120">    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-3-121">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching MobSF PDF report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-122">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="__span-3-123">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-3-124">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing MobSF PDF report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-3-125">        <span class="k">return</span> <span class="kc">None</span>
</span></code></pre></div></td></tr></table></div>
</li>
</ul>
<h2 id="dependencies">Dependencies</h2>
<ul>
<li><strong>MobSF (Mobile Security Framework):</strong> A mobile application security assessment framework. MobSF server must be running and accessible.</li>
<li><strong>Python Libraries:</strong><ul>
<li><code>requests</code>: For making HTTP requests to the MobSF API (<code>pip install requests</code>).</li>
<li><code>os</code>: For file system operations.</li>
<li><code>datetime</code>: For generating unique report filenames.</li>
<li><code>flask</code>: For accessing the application's root path and configuration.</li>
<li><code>PyMuPDF (fitz)</code>: For manipulating PDF reports and adding the company logo (<code>pip install pymupdf</code>).</li>
</ul>
</li>
</ul>
<h2 id="configuration">Configuration</h2>
<ul>
<li><strong>MobSF API URL and API Key:</strong> These are external configuration parameters that needs to be configured.</li>
<li><strong><code>COMPANY_LOGO_PATH</code>:</strong> Specifies the relative path to the company logo image within the Flask application's static files directory (e.g., <code>'static/images/company_logo.PNG'</code>).</li>
<li><strong><code>font_file</code></strong>: Specifies the location of the font file to load.</li>
</ul>
<h2 id="error-handling">Error Handling</h2>
<p>The script includes error handling for:</p>
<ul>
<li>Network connectivity issues when communicating with the MobSF API.</li>
<li>Invalid responses from the MobSF API.</li>
<li>File processing errors during PDF report generation and manipulation.</li>
<li>Font loading errors.</li>
</ul>
<p>Errors are printed to the console and returned as <code>None</code> by the functions.</p>
<h2 id="security-considerations">Security Considerations</h2>
<ul>
<li><strong>API Key:</strong> The MobSF API key is a sensitive credential. It's crucial to:<ul>
<li>Store the API key securely.</li>
<li>Avoid hardcoding the API key directly into the script. Use environment variables, configuration files, or a secret management solution.</li>
</ul>
</li>
<li><strong>Network Communication:</strong> Ensure that the communication channel between the script and the MobSF API is secure (HTTPS).</li>
<li><strong>File Handling:</strong> The script handles uploaded application files. Implement appropriate file type validation and size limits to prevent malicious uploads.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>